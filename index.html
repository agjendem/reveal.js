<!doctype html> <html lang="no">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Monorepo med Git og Maven: hvordan læra gamle hunder nye triks</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/sb1.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
                <section data-background="img/old-dog.jpg" data-background-size="contain">
                    <h2 style="text-shadow: 2px 2px 2px #C7C7C7;">Monorepo med Git og Maven</h2>
                    <br/><br/>
                    <h4 style="font-style: italic;color: white;text-shadow: 2px 2px 2px #282828;">hvordan lære gamle hunder nye triks</h4>
                    <br/><br/>
                    <br/><br/>
                    <br/><br/>
                    <hr/>
                    <small style="font-style: italic;color: white;">Anders Gjendem, Jonas Nordstrand</small>
                    <aside class="notes">
						Speaker notes til intro?
                        Bildkælla: https://pixabay.com/photos/dog-great-dane-old-animal-pet-2514968/ 
                    </aside>
				</section>

				<section>
					<h1>Agenda</h1>
					<ul>
                        <li>Monorepo 101</li>
						<li>Dilemmaet med felleskode</li>
						<li>Møt Monorepo</li>
						<li>Vår reise fra multi- til monorepo</li>
						<li>Utfordringar</li>
						<li>Effekter</li>
					</ul>
					<aside class="notes">
						<h6>En av oss:</h6>
						<p>
							Jeg heter ... og dette er ... og i dag skal vi snakke om våre erfaringer med monorepo.
						</p>
					</aside>
				</section>

                <section>
                    <h1>Monorepo 101</h1>

                    <h2>Mono</h2>

                    <!--
                    <ul>
                        <li>Oversikt</li>
                        <li>Vedlikholdbarhet</li>
                        <li>Versjonering</li>
                        <li>Forenkling</li>
                    </ul>
                    -->

                    <aside class="notes">
                        Monorepo ær ett kællkodesrepository dær man versionerar <strong>all</strong> kode i en organisation.

                        All kode innebær både:
                        <ul>
                            <li>appar</li>
                            <li>fellesfunktionalitet</li>
                        </ul>
                        vilket kan røra sig om:
                        <ul>
                            <li>backendkode</li>
                            <li>frontendkode</li>
                            <li>mobilappkode</li>
                        <ul>
                        som ær skriven i:
                        </ul>
                            <li>java</li>
                            <li>javascript</li>
                            <li>eller andra programmeringsspråk</li>
                        </ul>

                        I ett ortodox monorepo går man gærna ett steg længre. Det anses det att man ska kunna bygga
                        från bara de avhængigheter som ær incheckade i repo't. Vilket innebær att:
                        <ul>
                            <li>tredjeparts felleskode (maven central, npm-paket, etc.)</li>
                            <li>utvecklingsverktyg som JDK'er, kompilatorer, etc.</li>
                        </ul>
                        tillkommer - riktigt så långt har vi SpareBank1 inte kommit (ænnu).

                        Koden i ett monorepo ær modularisering/avdelad i ett hierarkiskt filtræd som checkas ut på
                        utvecklarnas arbetsstationer.

                        N.B.: Monorepo != Monolit. Alla monoliter ær monorepo'n, men alla monorepo'n ær <strong>inte</strong>
                        monolitiska. Vi ønskar sjælvstændig deploy av apparna i monorepot vår.
                    </aside>
                </section>

                <section>
                    <h1>Monorepo 101</h1>

                    <h2>Trunk-basert utvikling</h2>

                    <aside class="notes">
                        I ett monorepo sker all versionering med versionshanteringssystemet, i vårt, och flesta andra
                        tillfællen, git.

                        Vilken version av felleskoden
                        som en viss applikation drar in avgørs av git revisionen, inte versionsnummer angivna i pom.xml-filer.

                        Varje git-revision anger ett konsistent snapshot av alla avhængigheter mellan appar och felleskode.

                        Det ær inte møjligt att skjuta upp integration av felleskode genom att depend'a på en ældre
                        version så som man kan gøra med maven. Man avhænger i princip alltid på senaste version av allt.

                        Man prøvar att undgå långlevande brancher - featurebrancher merge'as ner till trunk/master så raskt som møjligt.

                        Det som ligger på trunk ska i størsta møjliga mån avspegla det som ær produktionssatt.

                        Monorepo innebær ett radikalt annorlunda sætt att jobba med felleskode æn multirepo och ger før- och nackdelar
                        på en rad olika områden.
                    </aside>
                </section>

                <section>
                    <section>
                        <h1>Felleskode</h1>

                        <h3>&ndash; a <i>mixed</i> blessing</h3>
                        <!--
                        <ul>
                            <li>Gevinst</li>
                            <li>Kobling</li>
                        </ul>
                        -->


                        <aside class="notes">
                            Tillæmpar man kodedelning primært med Copy-Paste så har man inte felleskode.<br/>

                            Om man har fancy en service-mesh / microservice-arkitektur, dær varje fellesfunktion ær sin egen tjeneste,
                            så har man kanske inte behov før felleskode, men &ndash; till och med Google har felleskode.<br/>

                            Har du inte felleskode så trenger du knappast monorepo!<br/>

                            Har du felleskode så kommer du  vilja du ha monorepo efter att ha fått med dig
                            denna talk'en!<br/>

                            Vi i SpareBank 1 har (ænnu) inte har microservices før all
                            fellesfunktionalitet.<br/>

                            Vi trenger felleskode før vi ær en bank, vi ønskar inte att vart och ett av vårt 18
                            utvecklingsteam ska utveckla var sin implementation av sessionsetablering i nettbanken
                            (och egentligen ønskar vi inte sessioner heller).<br/>

                            Samtidigt som felleskode ger helt
                            uppenbara vinster så leder den till ofrånkomlingen kopplingar mellan team som ær førødande før produktiviteten.
                        </aside>
                    </section>


                    <section data-timing="300">
                        <img src="img/felleskode-pr.png" alt="Bumping av versjonsnummer på mange interne bibliotek"/>

                        <aside class="notes">
                            <h6>En av oss:</h6>

                            Har du någon gång får en PR att review'a med en sådan hær diff?
                            En diff som bara innehåller bumpning'ar av versionsnummer før
                            felleskodeavhængigheter som appen din trenger?<br/>

                            Instick: versionsnummer i diffen: varfør står det dev och inte master dær?<br/>

                            Hur kændes det? Tog du dig bryet att eftergå exakt vilka kodeændringar
                            dessa, på ytan, så oskyldiga ændringar av versionnummer inførde?<br/>

                            Inte det..? Det ær svårt att klandra någon før det egentligen. Vi har
                            alltid mycket att gøra och finna fram till kodediffar i olika repo's baserat
                            på en diff som denna ær border-line infeasible i arbetsvardagen.
                            Att man kapitulerar och trots den lilla (eller stora) knuten i magen
                            væljer att Approve'a ær bara naturligt.<br/>

                            Måste det vara så hær? Kan man jobba felleskode på ett annat, smartare
                            sætt som leder till PR:s dær man faktiskt kan se vad det ær før något som ændras?

                            <hr/>
                            (5 min)
                            Utfordringer med klassisk modell for å håndtere felleskode:
                            Mange repository og artifaktpublisering (Arbeidsflyt, waste, branching modeller)

                        </aside>
                    </section>

                    <section data-background="img/app-deps-utan-jar.png" data-background-size="contain">
                        <aside class="notes">
                            Før att visa hur hur man gærna jobbar idag  med felleskode i ett multirepo-sammanhang
                            har vi hær ett exempel.
                            Två applikation och två felleskodemoduler. App1 avhænger av lib1 och lib2, medan app2
                            bara avhænger av lib2. Alla i sina egna repos.


                            <hr/>
                            TODO: se om det blir bættre om man lægger apparna i en kolonn till vænster och
                            libs i en kolonn till høger


                            Ett exempel: app1 ær en applikation som avhænger på felleskode i lib1,
                            app2 ær en applikation som avhænger på både lib1 och lib2
                            <hr/>
                            (5 min)
                            Utfordringer med klassisk modell for å håndtere felleskode:
                            Mange repository og artifaktpublisering (Arbeidsflyt, waste, branching modeller)

                        </aside>
                    </section>

                    <section data-background="img/app-deps-utan-jar-ci.png" data-background-size="contain">
                        <aside class="notes">
                            Det vi praktiken gør nær vi jobbar med felleskode i multireposammanhang ær att vi inte
                            depend:ar på koden till våra avhængigheter direkte &ndash;
                            istællet avhænger vi på byggda, versionerte artefakter, av koden. Dessa artefakterna uppbevaras
                            i særskila binærfilrepositories avskilda från kællkodesrepo't. I Maven-sammanhang gærna Nexus.
                        </aside>
                    </section>

                    <section data-background="img/app-deps-med-jar.png" data-background-size="contain">

                        <aside class="notes">
                            <h6>En av oss:</h6>
                            <p>
                                Ett exempel: man ønskar laga en feature i app1 som innebær att felleskode i lib2
                                samtidigt måste ændras. Detta måste rent praktiskt ordnas som två PR-processer:
                            </p>
                            <ul>
                                <li>
                                    <i>først</i> en PR i lib2-repo't dær diffen inte visar hur felleskodeændringen
                                    træffar app1. PR:n ær också inte heller møjlig att testa på en høgre nivå.
                                </li>
                                <li>
                                    Nær denna førsta PR:n ær mergead, och artefakt ær byggd och deploy'ad, kan man få
                                    vidare med app1-repo't och laga en <i>andra</i> PR som bumpar versionnumret før
                                    lib2-artefakten, integrerar app1:s kode med den nya versionen av lib2 och uppdaterar
                                    høgnivåtesterna.<br/>
                                    Denna PR:n ær møjlig att deploy'a till en testmiljø - vad som dæremot inte ær
                                    møjligt, eller i allafall praktiskt, ær att få en øversikt øver kodeændringarna i
                                    felleskoden som tas i bruk vid versionsbump'en.
                                </li>
                            </ul>
                            <p>
                                Som en lite kicker: ingen har tænkt på app2 (som också avhænger på lib2) i detta sammahanget.
                                Denna appen kan nu vara knæckt (nær man bumpar lib2-versionen)!
                            </p>
                        </aside>
                    </section>

                    <section>
                        <h1>Monorepo 201</h1>
                        <h4>Google's definisjon</h4>
                        <ul>
                            <li class="fragment fade-in">Centralization</li>
                            <li class="fragment fade-in">Synchronization</li>
                            <li class="fragment fade-in">Visibility</li>
                            <li class="fragment fade-in">Completeness</li>
                            <li class="fragment fade-in">Standardization</li>
                        </ul>
                        <br/><br/><br/>
                        <p>
                            <small>Kilde:
                                <a href="https://people.engr.ncsu.edu/ermurph3/papers/seip18.pdf">
                                    Advantages and Disadvantages of a Monolithic Repository - A case study at Google
                                </a>
                            </small>
                        </p>
                        <aside class="notes">
                            <h6>En av oss:</h6>
                            <p>
                                <br/>
                                (7 min)
                                Vi ønsker oss enkelheten til ett repo, men fordelene fra å ha mange:
                                Møt monorepo: Egenskaper (Cross cutting refactoring, søkbarhet, versjonering), og hvem
                                passer det for?
                            </p>
                        </aside>
                    </section>

                    <section>
                        <h1>Centralization</h1>

                        <blockquote>The codebase is contained in a single repo encompassing multiple projects
                        </blockquote>
                        <pre class="fragment"><code data-trim data-noescape>
.
├── apps
│   ├── app1
│   │   ├── pom.xml
│   │   └── src
│   ├── app2
│   │   ├── pom.xml
│   │   └── src
│   └── pom.xml
├── libs
│   ├── lib1
│   │   ├── pom.xml
│   │   └── src
│   ├── lib2
│   │   ├── pom.xml
│   │   └── src
│   └── pom.xml
├── pom.xml
├── README.md
                        </code></pre>
                        <aside class="notes">
                            Uppenbart det som diffentierar en monorepo-orgranisation från en som ær baserad på
                            multirepo.
                            Istællet før att modularisera olika appar och fellesbibliotek baser på många olika repos
                            låter man dem hanteras i repo och brukar filtrædet før att hålla dem især.
                            (1) Centralization: The codebase is contained in a single
                            repo encompassing multiple projects.
                        </aside>
                    </section>

                    <section>
                        <h1>Synchronization</h1>

                        <blockquote>The development process is trunkbased; engineers commit to the head of the repo
                        </blockquote>
                        <pre class="fragment"><code data-trim data-noescape>
$ find . -name '*.md' | \
  xargs sed -i 's/sparebank1/SpareBank 1/gi'
                        </code></pre>

                        <aside class="notes">
                            (3) Synchronization: The development process is trunkbased; engineers commit to the head of
                            the repo.
                            - Når vi gjør endringer i felleskode i dag, så kan det ta månedsvis før alle har tatt inn
                            endringene, og
                            det er vanskelig for den som endrer å gå rundt i alle prosjektene som bruker koden og rette
                            det selv.
                            Det gjør at når noen etterslepere endelig skal oppgradere, og har spørsmål, har man for
                            lengst glemt hva det handlet om.
                            Med monorepo må man også endre alle konsumentene, hvis ikke bryter bygget.

                        </aside>
                    </section>

                    <section>
                        <h1>Visibility</h1>
                        <blockquote>Code is viewable and searchable by all</blockquote>
                        <pre class="fragment"><code data-trim data-noescape>
$ git grep lib1 -- '**/pom.xml'
apps/app1/pom.xml:            &lt;groupId&gt;no.monorepo.libs.lib1&lt;/groupId&gt;
apps/app1/pom.xml:            &lt;artifactId&gt;lib1&lt;/artifactId&gt;
libs/lib1/pom.xml:    &lt;groupId&gt;no.monorepo.libs.lib1&lt;/groupId&gt;
libs/lib1/pom.xml:    &lt;artifactId&gt;lib1&lt;/artifactId&gt;
libs/pom.xml:        &lt;module&gt;lib1&lt;/module&gt;
                        </code></pre>
                        <aside class="notes">
                            (2) Visibility: Code is viewable and searchable by all
                            engineers in the organization.
                            - Her ligger en av de store gevinstene for oss.
                            Våre verktøy i dag er helt ubrukelig til å søke etter kode i.
                            Om du er så heldig å finne noe, så aner du ikke om den versjonen du ser er den som er i
                            bruk.
                        </aside>
                    </section>

                    <section>
                        <h1>Completenes</h1>

                        <blockquote>
                            Any project in the repo can be built only from dependencies also checked into the repo.
                            Dependencies are unversioned; projects must use whatever version of their dependency is at
                            the repo head.
                        </blockquote>

                        <aside class="notes">
                            - Denne er krevende å få til for en halvstor organisasjon.
                            Vi drar skillelinjen mellom tredjepartskode og vår felleskode.
                            De store kan ta kostnaden med å dra denne strikken enda lengre, og
                            versjonere _alt_ i eget repo, det er for ressurskrevende å følge
                            all tredjepartskode i detalj.
                            Vi har valgt å sjekke inn vår BOM som holder oversikt over- og
                            definerer hvilke tredjepartsbibliotek vi bruker.
                            <hr/>

                            (4) Completeness: Any project in the repo can be built
                            only from dependencies also checked into the repo.
                            Dependencies are unversioned; projects must use
                            whatever version of their dependency is at the repo
                            head.

                        </aside>
                    </section>

                    <section>
                        <h1>Standardization</h1>

                        <blockquote>
                            A shared set of tooling governs how engineers interact with the code, including building,
                            testing, browsing, and reviewing code.
                        </blockquote>


                        <aside class="notes">
                            - Monorepo har i praksis vært forbeholdt de store aktørene fordi tooling
                            koster. De nødvendige verktøyene for å bruke monorepo på store prosjekter
                            begynner nå å bli tilgjengelig. Google har open sourcet deler av sitt byggeverktøy
                            Bazel som i disse dager blir sluppet i versjon 1.0. Bazel er et graf-basert
                            byggverktøy. Google har også gjort tilgjengelig en plugin for IntelliJ slik at
                            det er relativt lett å ta i bruk. Microsoft har gjort
                            tilgjengelig sitt GVFS som gjør det mulig å versjonskontrollere
                            _store_ mengder kode i ett vanlig gitrepo. I tillegg har vi fått standarder som
                            CODEOWNERS for å håndtere eierskap til kode og reviewers på pull requests.
                            <hr/>
                            (5) Standardization: A shared set of tooling governs how
                            engineers interact with the code, including building,
                            testing, browsing, and reviewing code.
                        </aside>
                    </section>
                </section>

                <section>
					<section>
                        <h1>Vår reise</h1>

                        <ol>
                            <li class="fragment">Monolit</li>
                            <li class="fragment">Multirepo</li>
                            <li class="fragment">Monorepo</li>
                        </ol>


						<aside class="notes">
							<p>
                            SpareBank 1:s nett- och mobilbank var en illasinnad
                            enterprise java-monolit som versionskontrolleras først i Perforce, sedan Subversion och till sist i git.
                            Produktionssættningarna vara stora, komplicerade, långsamma och sællsynta. Det var i praktiken
                            omøjligt att skalera upp utvecklingsorganisationen till den nivå banken ønskade sig eftersom
                            vi aldrig skulle klarat att
                            produktionssætta allt som en større organisation skulle ha kunna producera i vilket fall som helst.
                            Någonting måste gøras.
                            </p>

                            <p>
                            Før cirka fem år sedan børjade vi bryta upp monoliten i mindre  applikationer som kunde
                            deploy'as fristånde från varandra. Utvecklingen av apparna sker idag
                            av dedikerade team som jobbar i egna repos. Mycket av koden i den gamla monoliten vidareførdes som felleskode
                            som apparna avhænger av. Felleskoden ligger i egna repos och byggs till binærer som uppbevaras i Nexus
                            på kænt java-manèr. Før att hantera ett stigande antal team (p.t ~20) som ansvarar før ett stændigt økande antal appar har vi
                            utvecklat omfattande intern tooling før att hålla apparna uppdaterade med senaste versioner felleskode.
                            </p>

                            <p>
                            Vi  utvecklar nu en ny generation av applikationer som ær tillståndsløsa, skyklara och som helt kuttar banden till den gamla monoliten,
                            Vi har fortfarande felleskode.
                            Vi har dock valt att utveckla våra nya appar och deras felleskode i ett monorepo.
                            Vi har utgått från de verktyg
                            som vi brukar och kænner gott sedan tidigare: git, Maven och Jenkins.
                            </p>

                            <h/>
                            (15 min)
                            Vår reise fra multi til monorepo.
                            Gå kjapt gjennom toolingen og repooppsettet vi hadde.
                            Hvordan kan vi få de gode egenskapene til monorepo uten å snu hele verden opp ned?
							</p>
						</aside>
					</section>

                    <section>
                        <pre><code data-trim data-noescape>
.
├── apps
│   ├── app1
│   │   ├── pom.xml
│   │   └── src
│   ├── app2
│   │   ├── pom.xml
│   │   └── src
│   └── pom.xml
├── libs
│   ├── lib1
│   │   ├── pom.xml
│   │   └── src
│   ├── lib2
│   │   ├── pom.xml
│   │   └── src
│   └── pom.xml
├── pom.xml
├── README.md

                        </code></pre>
                        <aside class="notes">
                            Vårt monorepo ær ett maven reactor multimodul-bygg med i huvudsak två toppnivå moduler:
                            <ul>
                                <li>apps - våra applikationer</li>
                                <li>libs - felleskoden</li>
                            </ul>

                        </aside>
                    </section>

                    <section>
                        <img src="img/maven-moduler.png" alt="oversikt over maven moduler i prosjektet" style="background:none; border:none; box-shadow:none; ">
                        <aside class="notes">

                            <h6>En av oss:</h6>
                            <p>Maven ær i grunden ett rekursivt byggsystem, ikke ett DAG-baserat 
                               som bazel.
                            </p>
                        </aside>
                    </section>

                    <section>
                        <img src="img/maven-moduler-deps.png" alt="oversikt over maven moduler i prosjektet med noen avhengigheter" style="background:none; border:none; box-shadow:none; ">
                        <aside class="notes">

                            <h6>En av oss:</h6>
                            <p>
                            Men kan ha avhængigheter på tværs av filtrædstruktur
                            </p>
                        </aside>
                    </section>
                    <section>
                        <pre><code data-trim data-noescape>
$ mvn clean install
[INFO] Scanning for projects...
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Build Order:
[INFO]
[INFO] root                                                               [pom]
[INFO] libs                                                               [pom]
[INFO] lib2                                                               [jar]
[INFO] lib1                                                               [jar]
[INFO] apps                                                               [pom]
[INFO] app1                                                               [jar]
[INFO] app2                                                               [jar]
[INFO]
                        </code></pre>
                        <aside class="notes">

                            <h6>En av oss:</h6>
                            <p>
                            Det ær avhængigheterna mellan modulerna som bestæmmer i vilken ordning
                               modulerna byggs.
                            </p>
                        </aside>
                    </section>

                    <section>
                        <pre><code data-trim data-noescape>
$ apps/app1 $ mvn clean install
[INFO] Scanning for projects...
[INFO]
[INFO] --------------------------< no.monorepo:app1 >--------------------------
[INFO] Building app1 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------

                        </code></pre>

                        <aside class="notes">
                            Hær bygget maven rekursivt från apps/app1 och bygger inga avhængigheter
                            till app1 som ligger utanfør aktuell arbetskatalog i filsystemet.
                        </aside>
                    </section>
                    <section>
                        <pre><code data-trim data-noescape>
apps/app1 $ mvn <mark>-f ../.. -pl :app1 -am</mark> clean install
[INFO] Scanning for projects...
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Build Order:
[INFO]
[INFO] root                                                               [pom]
[INFO] libs                                                               [pom]
[INFO] lib2                                                               [jar]
[INFO] lib1                                                               [jar]
[INFO] apps                                                               [pom]
[INFO] app1                                                               [jar]
[INFO]
                        </code></pre>
						<aside class="notes">
							<ul>
								<li>-f: --file (ange filsti till rot-pom, krævs før att Maven ska upptæcka alla moduler)</li>
								<li>-pl: --projects (projektlistan, vilka moduler Maven ska bygga) </li>
								<li>-am: --also-make (instruerar Maven att bygga alla avhængigheter till modulerna
									som angetts i projektlistan) </li>
							</ul>
						</aside>
                    </section>
					<section>
						<h1>partial-build-plugin</h1>
					</section>
					<section>
						<h1>Mavenutfordringer</h1>
						<ul>
							<li>version - bør utledes fra versjonskontroll</li>
							<li>groupId - bør utledes fra katalogstruktur</li>
							<li>Trenger nyere version av Maven for å unngå minnelekasje og få CI-vennlig "revisions"</li>
						</ul>
						<aside class="notes">
                            <p>Maven har en del utfodring i monoreposammanhang. Vi ska nu se nærmare på två av dem</p>
							<ul>
								<li>Bruk av project.version før att referer till monorepointerna dependencies</li>
								<li>ci-profil som sætter revision-property'n från miljøvariabel: fungerar næstan</li>
								<li>https://issues.apache.org/jira/browse/MNG-6412</li>
							</ul>
							<p>Bazel har inget versionsbegrepp, brukare utcheckade filstrukturen på disk som versionshanteras av VCS</p>
							<p>Bazel har inget grupperingsbegrepp à la maven groupId,
								gruppering på disk ær identiskt med katalogstrukturken</p>

						</aside>
					</section>
					<section>
                        <h1>Versjonering i Maven</h1>
                        <pre><code data-trim data-noescape>
&lt;project&gt;
  &lt;groupId&gt;no.monorepo.libs&lt;/groupId&gt;
  &lt;artifactId&gt;lib1&lt;/artifactId&gt;
  &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
					</code></pre>
                    </section>
                    <section>
                        <h1>CI-vennlig versjonering</h1>
                        <pre><code data-trim data-noescape>
&lt;project&gt;
  &lt;groupId&gt;no.monorepo.libs&lt;/groupId&gt;
  &lt;artifactId&gt;lib1&lt;/artifactId&gt;
  &lt;version&gt;${revision}&lt;/version&gt;

  &lt;properties&gt;
    &lt;revision&gt;1.0-SNAPSHOT&lt;/revision&gt;
  &lt;/properties&gt;
                        </code></pre>
						<pre class="fragment fade-up"><code data-trim data-noescape>
$ mvn -Drevision=$(git rev-parse HEAD) clean install
						</code></pre>
						<aside class="notes">
							<p>
                            Med <a href="https://maven.apache.org/maven-ci-friendly.html">ci-friendly</a>
							trenger man inte mutera pom-filer med mvn versions:set
							</p>
						</aside>
                    </section>
					<section>
						<h1>Flate pom-filer</h1>
						<aside class="notes">
							<p>
                            Før att undgå att pom-filer med ikke-resolverade $revision inslag blir installerade bør
							man bruka Maven flatten-plugin'en. Denna resolva'r revision och installerar en flat pom.xml fil
							som man kan bruka i framtida bygg utan problem.
                            </p>
						</aside>
					</section>
					<section>
                        <pre><code data-trim data-noescape>
&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;no.monorepo.libs.lib1&lt;/groupId&gt;
    &lt;artifactId&gt;lib1&lt;/artifactId&gt;
    &lt;version&gt;${project.version}&lt;/version&gt;
  &lt;/dependency&gt;
						</code></pre>
					</section>
					<section>
						<h1>filsti == groupId</h1>
						<p><span><code>libs/lib1</code> &rArr;</span> <code class="fragment fade-in">no.monorepo.libs.lib1</code></p>
						<p><span class="fragment fade-in"><code>apps/app2</code> &rArr;</span> <code class="fragment fade-in">no.monorepo.apps.app2</code></p>
						<aside class="notes">
							<p>Maven's namespace før moduler ær baserat på groupId-begreppet. I ett monorepo ær name space
							ivaratatt av filkatalog-hiearkin. Nær man brukar Maven før monorepo bør man vurdera att sætta
							groupId identisk med filsti.</p>
						</aside>
					</section>
					<section>
						<h1>CODEOWNERS</h1>
						<pre class="fragment fade-up"><code data-trim data-noescape>
# Default owner
/ @nordstrand

# Code owner for the applications
/apps/app1/   @nordstrand
/apps/app2/   @agjendem
						</code></pre>

						<img src="img/codereview-in-github.png" alt="eksempel på hvordan github viser codereviewers via codeowners-fil" class="fragment fade-in"/>

						<aside class="notes">
							<p>En av de stor førdelarna med multirepo ær att det ær lætt før team att vara autonoma och på egen hand sætta
							upp och administrera rutiner kring tilgång till kællkod och rutiner kring peer review.
                            I ett monorepo som delas mellan teams måste detta centraliseras på tværs av team i større utstræckning.
                            Ett vanligt uppsætt ær att øppna før read før alla, men kræva godkænd pull request før att få lov att ta
                            ned kode på trunk.
                            </p>

							<p>
							En CODEOWNERS-fil i monorepot definierar vilka team/teammedlemmar som æger koden under olika filstier.
							Detta kan brukas till f.eks. automatiskt lægga in ægare som reviewers på pull request:er som træffar
                            deras respektive kode.
                            </p>

							<p>
                            CODEOWNERS-filformatet ær <a href="https://help.github.com/articles/about-codeowners/">standardiserat</a>
							och støds av Github (før tillfællet bara i betalt/PRO-utførande), Gitlab och Bitbucket Server (med plugin).
							</p>

							<p>
                            I detta exemplet blir Anders automatiskt lagt till som reviewer (med speciell-nøkkehålikon) på alla PR:s
							som træffar hans app - app2.
                            </p>
						</aside>
					</section>
                    <section>
                        <h1>Jenkins(file)</h1>
                        <aside class="notes">
                            I ett monorepo vill man ha møjligt att køra olika byggpipelines beroende på vilka filer som har ændrat sig.
                            Det har i utgångspunkt inte Jenkins stød før, och det finns inte heller læmpliga plugins att tillgå.
                            Vi har løst detta med en root Jenkinsfile som hjælp av git ... finner fram till vilka filer som har ændrats,
                            finner træffade Jenkinsfile och delegerar till den mest specifikat.

                            På så sætt kan vi olika pipelines før olika appar.

                            Gør man ændring på felleskode har vi p.t. inget smart system - utan en default pipeline som bygger hela
                            monorepo't kørs.
                        </aside>
                    </section>

                    <section>
                        <h1>Git sparse checkouts</h1>
                        <pre class="fragment fade-up"><code data-trim data-noescape>
.git/info/sparse-checkout
/*
!/apps/*/*
/apps/app1/*
                        
                       </code></pre>
                        <aside class="notes">
                        <p>
                        Med sparse checkouts kan man kan instruera git att checka ut en delmængd av arbetstrædet. F.eks. kan man vælja att
                        checka ut bara den applikation som man jobbar med før tiden. Det kan vara førdelaktig i førhållande till indexeringstid
                        i IntelliJ.

                        Med sparse checkouts får man i praktiken en utvecklarupplevelse som ær rætt lik den man har med multirepo.
                        </p>
                        <p>
                        I exemplet:
                        <ul>
                            <li>checkat hela repo't ut</li>
                            <li>utan några appars</li>
                            <li>men app1 vill vi ha</li>
                        </ul>
                        </aside>
                    </section>
                    <section>

                        <pre><code data-trim data-noescape>
&lt;profile&gt;
  &lt;id&gt;app2&lt;/id&gt;
  &lt;activation&gt;
    &lt;file&gt;
      &lt;exists&gt;app2/pom.xml&lt;/exists&gt;
    &lt;/file&gt;
  &lt;/activation&gt;
  &lt;modules&gt;
    &lt;module&gt;app2&lt;/module&gt;
  &lt;/modules&gt;
&lt;/profile&gt;
                        </code></pre>
                        <aside class="notes">
							<p>
							I utgångspunkt hanterar inte Maven sparse checkouts. Maven ønskar bygga upp en komplett modell av alla moduler
							baserat på pom.xml:arna. Om en submodul inte ær utcheckad på disk trynar maven.
							</p>
							<p>
							Med hjælp av kreativt bruk av mavenprofiler, som aktiveras bara nær pom.xml-filer ær utcheckat i trædet,
							ær det møjligt att jobba runt problemet.
							</p>
                        </aside>
                    </section>
					<section>
                        Restpost
						<aside class="notes">
							<h6>En av oss:</h6>
                            <h1>Løsninger</h1>
                            <ul>
                                <li>GVFS / large file storage</li>
                                <li>Bazel?</li>
                                <li>Archunit?</li>
                            </ul>
	                            <ul>
                                <li>Bazel?
                                    <ul>
                                        <li>JVM-external</li>
                                        <li>Maven-dependencies</li>
                                        <li>IntelliJ-støtte</li>
                                    </ul>
                                </li>
                                <li>Python i Monorepo?</li>
                                <li>Rydde i repo</li>
                                <li>Archeunit.org - medisin mot monolitt i monorepo
                                    <ul>
                                        <li>no.sb1.apps.app_a</li>
                                        <li>no.sb1.libs</li>
                                        <li>Hva med Python og Go?</li>
                                    </ul>
                                </li>
                            </ul>
						</aside>
					</section>
				</section>

				<section>
					<section>
						<h1>Rosa sky eller tornekratt?</h1>

                        <ul>
                            <li>Stort repo</li>
                            <li>Lange byggtider</li>
                            <li>The race to push</li>
                            <li>Monolit 2.0</li>
                            <li>Verktøy</li>

                       </ul>
						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
								(7 min)
								Hvilke nye utfordringer får vi nå?
								* Umodne verktøy (Maven vs Bazel, BitBucket / GitHub vs Gerrit)
								* Tvinges til mer kortlevde brancher
								* Skalering
							</p>
						</aside>
					</section>

                    <section>
                        <h1>Stort repo</h1>
                        <ul>
                            <li>.git/</li>
                            <li>work tree</li>
                        </ul>

                        <aside class="notes">
                            Sparse checkouts hjælper mot stora working trees.

                            Næmn något kring andra stora repos som googles, microsoft windowsrepot 3.5 milj. filer/4000 brukare(som GVFS)
                            Linuxkerneln har bara 65000 filer

                            SpareBank 1:s nettbank har en kodbas på cirka X filer. X ær dock ett osækert estimat, det ær
                            svårt att få øverblik eftersom vi fortfarande har mycket multirepo-kode. I ett monorepo ær det triviellt
                            att ta fram siffran.
                            Hantering av stora filer/binærer: "Git large file support"
                        </aside>
                    </section>

                    <section>
                        <h1>Lange byggtider</h1>
                        <ul>
                            <li>Ikke bygg alt alltid</li>
                            <li>Ikke bygg fra "clean" alltid <span class="fragment fade-in">(vurder alternativ til Maven)</span></li>
                            <li class="fragment fade-in">Bazel har støtte for <i>build cache</i> og <i>build workers</i></li>
                        </ul>

                        <aside class="notes">
                            Bazel har stød før 100% pålitligta inkrementella bygg vilket troligen hjælper till med CI rætt bra.
                        </aside>
                    </section>

                    <section>
                        <h1>The race to push</h1>

                        <aside class="notes">
                            <a href="https://docs.microsoft.com/en-us/azure/devops/learn/git/race-to-push">The race to push</a>
                        </aside>
                    </section>

                    <section>
                        <h1>Monolit 2.0</h1>

                        <aside class="notes">
                            Ett monorepo ger goda førutsættningar før att producera en ny tætt kopplat monolit/big-ball-of-mud.

                            Detta må vi undgå. Kanske kan archunit hjælpa?
                        </aside>
                    </section>

                    <section>
                        <h1>Overmodne verktøy</h1>
                        <ul>
                            <li>Maven er javasentrisk og "clunky" i et monorepo</li>
                            <li>Jenkins mangler monorepo-støtte</li>
                        </ul>
                        <aside class="notes">
                            <p>
                            Førsta release av <a href="https://maven.apache.org/docs/history.html">Maven slæpptes 30 mars 2002</a>.
                            Maven ær alltså ældre æn git, FaceBook och java generics och firar snart 20-årsjubileum...
                            </p>
                            <p>
                            Maven clunkyness i monorepo-sammanhang:
                            </p>
                            <ul>
                                <li>Ikke polyglot - javacentrisk</li>
                                <li>Sparse checkout måste hackas, mavens repomodell byggs upp av pom.xml filer
                                    - ikke vad som finns på disk</li>
                                <li>Maven trenger explicit referens till roten av repo't, Bazel finner den fint sjælv</li>
                                <li>Manglar inkrementella bygg</li> 
                                <li>Maven brukar groupId och version-begrepp før moduler som i ett monorepo hellre avleds
                                    från filkatalogstrukt resp. git</li>
                            </ul>
                            <p>Jenkins ær en annan gammal travare som først såg dagens ljus under namnet Hudson tillbaka i 2008. Många år och
                            många plugins senare så saknar Jenkins fortsatt monorepostød.
                            </p>
                        </aside>
                    </section>

                    <section>
                        <h1>Umodne verktøy</h1>
                        <ul>
                            <li>Bazel er i beta og har middels verktøystøtte</li>
                            <li>CI - mangler ferdige løsninger for å bygge deler av monorepo</li>
                            <li>Bitbucket/Github mangler ordentlig støtte for store monorepo - CODEOWNERS er et plaster</li>
                        </ul>
                        <aside class="notes">
                            <p>
                            CodeFresh har <a href="https://codefresh.io/continuous-integration/using-codefresh-with-mono-repos/">stød før monorepo</a>!
                            </p>
                        </aside>
                    </section>

                    <section>
                        <h1>... men dere gjør det jo feil!</h1>
                        <ul>
                            <li>Dette er jo ikke et ekte monorepo!</li>
                            <li><a href="https://medium.com/@mattklein123/monorepos-please-dont-e9a279be011b">Monorepo er latterlig, ikke gjør det!</a></li>
                            <li>Dere støtter jo bare ett språk!</li>
                            <li>Dere har jo bare noen få applikasjoner i repoet!</li>
                            <li>Definisjonen er jo at _alt_ av kode skal bo i ett repo!</li>
                            <li>Monorepo skalerer ikke</li>
                            <li>Monorepo er en flopp|hype</li>
                            <li>.. andre innspill?</li>
                        </ul>
                        <aside class="notes">
                            <p>
                                Det er fordeler og ulemper med alt. Vi har nå prøvd multirepo i ganske mange år, og
                                håndterer forsåvidt det "greit nok" - men det er ikke gøy med 100+ repository heller.

                                Nå hadde vi muligheten til å se på om monorepo kunne løse noen av våre utfordringer,
                                og vi har tid og lyst til å se om dette kan være noe for oss i større eller mindre skala.

                                Mange av ankepunktene mot monorepo gjelder store organisasjoner med enorme mengder kode.
                                Vi har mange utviklere, vi har mye kode, på mange språk, men vi er på ingen måte enorme.
                                Det finnes kanskje en middelvei her?

                                Vi tror at ved å begynne i det små og ta stegene gradvis så bør vi greie å komme opp med en god løsning på utfordringene,
                                og kunne løse de større over tid når de nærmer seg et problem. Foreløpig er vel kanskje
                                hybrid-repo et bedre navn på det vi gjør, og vi tenker at det er helt greit å ta skrittene
                                gradvis. Det er ikke gitt at det er fornuftig for oss å blande alt i en stor haug, men
                                å samle det som hører sammen virker forlokkende, ihvertfall.

                                Hvis dette ikke er en flopp, så har det en tendens til å dukke opp løsninger på utfordringene
                                i form av nye verktøy og bedre tredjepartsstøtte, se bare på Bazel.

                                Vi ser ingen grunn til å ikke utforske mulighetene, og i verste fall så er det ingen big deal å splitte
                                opp til flere repository igjen, den biten kan vi. Også er det jo også slik at vi har
                                brukt, og bruker den dag i dag mye tid på tooling for multirepo også.

                                Igjen; alt gjør vondt, spørsmålet er bare hvor du foretrekker å ha smerten.
                            </p>
                        </aside>
                    </section>
				</section>

				<section>
                    <section>
                        <h1>Effekter</h1>

                        <aside class="notes">
                            <h6>En av oss:</h6>
                            <p>
                            (7 min)
                            Med monorepo; hva blir mer viktig, og hva blir mindre viktig?
                            Hvordan påvirker monorepo samarbeidet i organisasjonen?
                            Positive bi-effekter av monorepo.
                            </p>
                        </aside>
                    </section>
					<section>
                        <h1>Versjonering</h1>
						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
                                Tidigare versionerade vi i git _och_ maven. I monorepo versionerar vi bara i git.

                                Konceptuellt lættare att førhålla sig till git (en viss SHA1 tillsvarar att
                                allt ska vara i sync), æn att førhålla sig till &lt;dependencyManagement&gt;,
                                bom'ar, snapshots, dependency version convergence (risiko før detta utgår helt på
                                egen felleskode i monorepot, 3e part kan fortfarande vara ett issue om dessa ikke
                                också ligger i monorepot), maven sin release-plugin, NPM:s semver, pinning, lock-filer,
                                etc. etc. allt annat som folk uppfunnit genom historiens før før att
                                førsøka gøra versionering av felleskode i artefaktregistries levlig.
							</p>
						</aside>
					</section>
                    <section>
                        <h1>Endring i felleskode</h1>
                        <h4>Bilde av overlykkelige folk som kaster blomster rundt om?</h4>
                        <aside class="notes">
                            <h6>En av oss:</h6>
                            <p>
                                Tidigare kunde man ændra felleskode utan att att ta ansvara før att integrera
                                ændringen i konsumenterna. Med monorepo blir man mer ansvarligt før konsumenterna,
                               det blir också praktiskt møjligt att gøra det.

                               Holistiska PR dær man ser alla ændringar och det blir praktiskt møjligt med en
                               helhetlig code review.

                               Atomiska refaktoreringar.

                               T2M før felleskodeændring/sikkerhetspatching går radikalt ned. True _continous_ integration!

                               Mindre behov før komplex tooling før att hålla appar uppdaterade med nya versioner
                               av felleskode.
                                
                               Praktiskt møjligt att få rask feedback på konsekveserna av ændring av felleskode,
                               sænker trøskeln før att att folk vågar refaktorer/bidra till felleskode.
                            </p>
                        </aside>
                    </section>
                    <section>
                        <h2>Du får det till med Maven, Jenkins og Git!</h2>
                        <h2 class="fragment fade-in">...men på sikt ryker nok Maven!</h2>
                    </section>
				</section>


				<section>
					<h1>Takk for oss!</h1>

					<p>
						<a href="https://github.com/SpareBank1/monorepo-sample">github.com/SpareBank1/monorepo-sample</a><br/>
						<img style="width:300px;height:300px" alt="QR-kode til https://github.com/SpareBank1/monorepo-sample" src="img/repo-url-qr.png" />
					</p>

					<h4>kortreistkode.no</h4>
					<h4>Jonas Nordstrand / Anders Gjendem</h4>

					<aside class="notes">
						<h6>En av oss:</h6>
						<p>
							Hejdå!
						</p>
					</aside>
				</section>

                <!--
                  TODO:s

                  DELIVERY

                  JONAS:
                   * Sluta "smacka"!
                -->
			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
                history: true,
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true }
				]
			});
		</script>
	</body>
</html>
