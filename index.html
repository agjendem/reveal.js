<!doctype html>
<html lang="no">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/sb1.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1>&lt;Ventebilde/&gt;</h1>
					<aside class="notes">
						Speaker notes til intro?
					</aside>
				</section>

				<section>
					<h1>Agenda</h1>
					<ul>
						<li>Dilemmaet med felleskode</li>
						<li>Utfordringer..?</li>
						<li>Møt Monorepo</li>
						<li>Vår reise fra multi- til monorepo</li>
						<li>Rosa sky eller tornekratt?</li>
						<li>Effekter</li>
					</ul>
					<aside class="notes">
						<h6>En av oss:</h6>
						<p>
							Jeg heter ... og dette er ... og i dag skal vi snakke om våre erfaringer med monorepo.
						</p>
					</aside>
				</section>

				<section>
					<section data-timing="180">
						<h1>Dilemmaet med felleskode</h1>

						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
								(3 min)
								Intro: Dilemmaet med felleskode: gevinst vs kobling
							</p>
						</aside>
					</section>

					<section>
						<ul>
							<li>Hvorfor</li>
							<li>Hva
								<ul>
									<li>Monolit != Monorepo</li>
									<li>core</li>
									<li>Polyglot?</li>
								</ul>
							</li>
						</ul>

						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
                            <a href="https://people.engr.ncsu.edu/ermurph3/papers/seip18.pdf">
                                Advantages and Disadvantages of a Monolithic Repository - A case study at Google
                            </a>
                            <br/>
                            <a href="https://docs.microsoft.com/en-us/azure/devops/learn/git/race-to-push">The race to push</a>
							</p>
						</aside>
					</section>
				</section>

				<section data-timing="300">
					<img src="img/felleskode-pr.png" alt="Bumping av versjonsnummer på mange interne bibliotek"/>

					<aside class="notes">
						<h6>En av oss:</h6>
						<p>
							Har du någon gång får en PR att review'a med en sådan hær diff?
                            En diff som bara innehåller bumpning'ar av versionsnummer før
                            felleskodeavhængigheter som appen din trenger?<br/>

                            Hur kændes det? Tog du dig bryet att eftergå exakt vilka kodeændringar
                            dessa, på ytan, så oskyldiga ændringar av versionnummer inførde?<br/>

                            Inte det..? Det ær svårt att klandra någon før det egentligen. Vi har
                            ofta mycket att gøra och finna fram till kodediffar i olika repo's baserat
                            på en diff som denna ær border-line infeasible i en arbetsvardagen.
                            Att man kapitulerar och trots den lilla (eller stora) knuten i magen 
                            væljer att Approve'a ær bara naturligt.<br />

                            Måste det vara så hær? Kan man jobba felleskode på ett annat, smartare
                            sætt som leder till PR:s dær man faktiskt kan se vad det ær før kodeændringar
                            som inførs?

							(5 min)
							Utfordringer med klassisk modell for å håndtere felleskode:
								Mange repository og artifaktpublisering (Arbeidsflyt, waste, branching modeller)
						</p>
					</aside>
				</section>

                <section>
                    <img src="img/app-deps-utan-jar.png" style="background:none; border:none; box-shadow:none;">


                    <aside class="notes">
                        <h6>En av oss:</h6>
                        <p>
                        Ett exempel: app1 ær en applikation som avhænger på felleskode i lib1,
                        app2 ær en applikation som avhænger på både lib1 och lib2

                        (5 min)
                        Utfordringer med klassisk modell for å håndtere felleskode:
                        Mange repository og artifaktpublisering (Arbeidsflyt, waste, branching modeller)
                        </p>
                    </aside>
                </section>
                <section>
                    <img src="img/app-deps-med-jar.png" style="background:none; border:none; box-shadow:none;">


                   <aside class="notes">
                       <h6>En av oss:</h6>
                       <p>
                         Det vi praktiken gør med maven  ær att vi inte dependar på koden till våra avhængigheter,
                         istællet avhængigheter vi på byggda, versionerte artefakter, av koden. Detta føljer av
                         att varje kodebas tradionellt versionskontrollers i var sitt repo.

                         Ett exempel: man ønskar laga en feature i app1 som innebær att felleskode i lib1 samtidigt
                         måste ændras. Detta måste rent praktiskt ordnas som två PR-processer:
                         først en PR i lib1 dær
                         man inte ser ut felleskodeændringen træffar en ny app och som dærfør inte heller
                         ær møjlig att testa i en testmiljø.
                         Nær denna PR ær mergead, och artefakt ær byggd, kan man få vidare med app1
                         dær man nu lagar en PR som bumpar versionnumret før artefakten. Denna PR kan
                        man inte se kodeændringen i libet i. Men man kan deploy'a och testa appen.

                        Som en lite kicker: ingen har tænkt på app2 i sammahangen. Denna kan nu vara knæckt!

                       (5 min)
                       Utfordringer med klassisk modell for å håndtere felleskode:
                       Mange repository og artifaktpublisering (Arbeidsflyt, waste, branching modeller)
                       </p>
                   </aside>
                </section>
				<section>
					<h1>Møt monorepo!</h1>

					<aside class="notes">
						<h6>En av oss:</h6>
						<p>
							(7 min)
							Vi ønsker oss enkelheten til ett repo, men fordelene fra å ha mange:
								Møt monorepo: Egenskaper (Cross cutting refactoring, søkbarhet, versjonering), og hvem passer det for?
						</p>
					</aside>
				</section>

				<section>
					<section>
						<h1>Vår reise fra multi- til monorepo</h1>

						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
								(15 min)
								Vår reise fra multi til monorepo.
								Gå kjapt gjennom toolingen og repooppsettet vi hadde.
								Hvordan kan vi få de gode egenskapene til monorepo uten å snu hele verden opp ned?
							</p>
						</aside>
					</section>

                    <section>
                        <pre><code data-trim data-noescape>
.
├── apps
│   ├── app1
│   │   ├── pom.xml
│   │   └── src
│   ├── app2
│   │   ├── pom.xml
│   │   └── src
│   └── pom.xml
├── libs
│   ├── lib1
│   │   ├── pom.xml
│   │   └── src
│   ├── lib2
│   │   ├── pom.xml
│   │   └── src
│   └── pom.xml
├── pom.xml
├── README.md

                        </code></pre>
                    </section>

                    <section>
                        <img src="img/maven-moduler.png" style="background:none; border:none; box-shadow:none; ">
                        <aside class="notes">

                            <h6>En av oss:</h6>
                            <p>Maven ær i grunden ett rekursivt byggsystem, ikke ett DAG-baserat 
                               som bazel.
                            </p>
                        </aside>
                    </section>

                    <section>
                        <img src="img/maven-moduler-deps.png" style="background:none; border:none; box-shadow:none; ">
                        <aside class="notes">

                            <h6>En av oss:</h6>
                            <p>Men kan ha avhængigheter på tværs av filtrædstruktur
                            </p>
                        </aside>
                    </section>
                    <section>
                        <pre><code data-trim data-noescape>
$ mvn clean install
[INFO] Scanning for projects...
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Build Order:
[INFO]
[INFO] root                                                               [pom]
[INFO] libs                                                               [pom]
[INFO] lib2                                                               [jar]
[INFO] lib1                                                               [jar]
[INFO] apps                                                               [pom]
[INFO] app1                                                               [jar]
[INFO] app2                                                               [jar]
[INFO]
                        </code></pre>
                        <aside class="notes">

                            <h6>En av oss:</h6>
                            <p>Det ær avhængigheterna mellan modulerna som bestæmmer i vilken ordning
                               modulerna byggs.
                            </p>
                        </aside>
                    </section>

                    <section>
                        <pre><code data-trim data-noescape>
$ apps/app1 $ mvn clean install
[INFO] Scanning for projects...
[INFO]
[INFO] --------------------------< no.monorepo:app1 >--------------------------
[INFO] Building app1 1.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------

                        </code></pre>

                        <aside class="notes">
                            Hær bygget maven rekursivt från apps/app1 och bygger inga avhængigheter
                            till app1 som ligger utanfør aktuell arbetskatalog i filsystemet.
                        </aside>
                    </section>
                    <section>
                        <pre><code data-trim data-noescape>
apps/app1 $ mvn <mark>-f ../.. pl :app1 -am</mark> clean install
[INFO] Scanning for projects...
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Build Order:
[INFO]
[INFO] root                                                               [pom]
[INFO] libs                                                               [pom]
[INFO] lib2                                                               [jar]
[INFO] lib1                                                               [jar]
[INFO] apps                                                               [pom]
[INFO] app1                                                               [jar]
[INFO]
                        </code></pre>
						<aside class="notes">
							<ul>
								<li>-f: --file (ange filsti till rot-pom, krævs før att Maven ska upptæcka alla moduler)</li>
								<li>-pl: --projects (projektlistan, vilka moduler Maven ska bygga) </li>
								<li>-am: --also-make (instruerar Maven att bygga alla avhængigheter till modulerna
									som angetts i projektlistan) </li>
							</ul>
						</aside>
                    </section>
					<section>
						<h1>partial-build-plugin</h1>
					</section>
					<section>
						<h1>Mavenutfodringar</h1>
						<ul>
							<li>version - bør hærledas från versionskontroll instællet</li>
							<li>groupId - bør hærledes från filtrædstruktur istællet</li>
							<li>Trenger ny version av Maven: minnelæckagefixar och CI-friendly versions</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Bruk av project.verision  før att referer till monorepointerna dependencies</li>
								<li>ci-profil som sætter revision-property'n från miljøvariabel: fungerar næstan</li>
								<li>https://issues.apache.org/jira/browse/MNG-6412</li>
							</ul>
							<p>Bazel har inget versionsbegrepp, bygger filstrukturen på disk som versionshanteras av VCS</p>
							<p>Bazel har inget grupperingsbegrepp à la maven groupId,
								gruppering på disk ær identiskt med katalogstrukturken</p>

						</aside>
					</section>
					<section>
                        <h1>Versionering i Maven</h1>
                        <pre><code data-trim data-noescape>
&lt;project&gt;
  &lt;groupId&gt;no.monorepo.libs&lt;/groupId&gt;
  &lt;artifactId&gt;lib1&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
					</code></pre>
                    </section>
                    <section>
                        <h1>CI-friendly versioning</h1>
                        <pre><code data-trim data-noescape>
&lt;project&gt;
  &lt;groupId&gt;no.monorepo.libs&lt;/groupId&gt;
  &lt;artifactId&gt;lib1&lt;/artifactId&gt;
  &lt;version&gt;${revision}&lt;/version&gt;

  &lt;properties&gt;
    &lt;revision&gt;1.0-SNAPSHOT&lt;/revision&gt;
  &lt;/properties&gt;
                        </code></pre>
						<pre class="fragment fade-up"><code data-trim data-noescape>
$ mvn -Drevision=$(git rev-parse HEAD) clean install
						</code></pre>
						<aside class="notes">
							<p>Med <a href="https://maven.apache.org/maven-ci-friendly.html">ci-friendly</a>
								trenger man inte mutera pom-filer med mvn versions:set
							</p>
						</aside>
                    </section>
					<section>
						<h1>Flata pom-filer</h1>
						<aside class="notes">
							<p>Før att undgå att pom-filer med ikke-resolverade $revision inslag blir installerade bør
							man bruka Maven flatten-plugin'en. Denna resolva'r revsion och installerar en flat pom.xml fil
							som man kan bruka vidare utan problem</p>
						</aside>
					</section>
					<section>
                        <pre><code data-trim data-noescape>
&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;no.monorepo.libs.lib1&lt;/groupId&gt;
    &lt;artifactId&gt;lib1&lt;/artifactId&gt;
    &lt;version&gt;${project.version}&lt;/version&gt;
  &lt;/dependency&gt;
						</code></pre>
					</section>
					<section>
						<h1>filsti == groupId</h1>
						<p><span><code>libs/lib1</code> &rArr;</span> <code class="fragment fade-in">no.monorepo.libs.lib1</code></p>
						<p><span class="fragment fade-in"><code>apps/app2</code> &rArr;</span> <code class="fragment fade-in">no.monorepo.apps.app2</code></p>
						<aside class="notes">
							<p>Maven's namespace før moduler ær baserat på groupId-begreppet. I ett monorepo ær name space
							ivaratatt av filkatalog-hiearkin. Nær man brukar Maven før monorepo bør man vurdera att sætta
							groupId identisk med filsti.</p>
						</aside>
					</section>
					<section>
						<h1>CODEOWNERS</h1>
						<pre class="fragment fade-up"><code data-trim data-noescape>
# Default owner
/ @nordstrand

# Code owner for the applications
/apps/app1/   @nordstrand
/apps/app2/   @agjendem
						</code></pre>

						<img src="img/codereview-in-github.png" class="fragment fade-in"/>

						<aside class="notes">
							<p>En av de stor førdelarna med multirepo ær att det ær lætt før team att vara autonoma och sætta
							upp egna rutiner kring tilgång till kællkod och rutiner kring peer review, Pull Requests på egen hand.
							I ett monorepo måste detta centraliseras i større utstræckning på tværs av team. Ett vanligt
							uppsætt ær att øppna før read før alla, men kræva godkænd pull request før att få lov att ta ned kode på trunk.</p>

							<p>
							En CODEOWNERS-fil i monorepot gør det møjligt att ange vilka team/teammedlemmar som æger koden under olika filstier.
							Detta kan brukas till f.eks. automatiskt lægga in ægare som reviewers på Pull requester som træffar
								deras respektive kode.</p>

							<p>CODEOWNERS-filformatet ær <a href="https://help.github.com/articles/about-codeowners/">standardiserat</a>
							och støds av Github (før tillfællet bara i betalt/PRO-utførande), Gitlab och Bitbucket Server (med plugin).
							</p>

							<p>I detta exemplet blir Anders automatiskt lagt till som reviewer (med speciell-nøkkehålikon) på alla PR:s
							som træffar hans app - app2.</p>
						</aside>
					</section>


					<section>
						<h1>Løsninger</h1>
						<ul>
							<li>Git VFS / large file storage</li>
							<li>Bazel?</li>
							<li>Archunit?</li>
						</ul>
					</section>

					<section>
						<ul>
							<li>CI-vennlig + flatten</li>
							<li>Jenkinsfile / git diff</li>
							<li>Git sparse checkout</li>
							<li>Git merge strategies</li>
							<li>Bazel?
								<ul>
									<li>JVM-external</li>
									<li>Maven-dependencies</li>
									<li>IntelliJ-støtte</li>
								</ul>
							</li>
							<li>Codeowners-plugin til BitBucket</li>
							<li>Lage maven vs bazel repo some "giveaways" + QR</li>
							<li>Python i Monorepo?</li>
							<li>Rydde i repo</li>
							<li>Archeunit.org - medisin mot monolitt i monorepo
								<ul>
									<li>no.sb1.apps.app_a</li>
									<li>no.sb1.libs</li>
									<li>Hva med Python og Go?</li>
								</ul>
							</li>

						</ul>

						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
							</p>
						</aside>
					</section>
				</section>

				<section>
					<section>
						<h1>Rosa sky eller tornekratt?</h1>

						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
								(7 min)
								Hvilke nye utfordringer får vi nå?
								* Umodne verktøy (Maven vs Bazel, BitBucket / GitHub vs Gerrit)
								* Tvinges til mer kortlevde brancher
								* Skalering
							</p>
						</aside>
					</section>

					<section>
						<ul>
							<li>Byggetid</li>
							<li>Merge</li>
							<li>Repository size
								<ul>
									<li>Maskinlæringsmodeller</li>
								</ul>
							</li>
							<li>Konsistens</li>
							<li>Standardisering
								<ul>
									<li>Generator / Yeoman</li>
								</ul>
							</li>
						</ul>

						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
							</p>
						</aside>
					</section>
				</section>

				<section>
					<h1>Effekter</h1>

					<aside class="notes">
						<h6>En av oss:</h6>
						<p>
							(7 min)
							Med monorepo; hva blir mer viktig, og hva blir mindre viktig?
							Hvordan påvirker monorepo samarbeidet i organisasjonen?
							Positive bi-effekter av monorepo.
						</p>
					</aside>

					<section>

						<aside class="notes">
							<h6>En av oss:</h6>
							<p>
							</p>
						</aside>
					</section>
				</section>

				<section>
					<h1>Takk for oss</h1>

					<p>
						<a href="https://github.com/SpareBank1/monorepo-sample">github.com/SpareBank1/monorepo-sample</a><br/>
						<img width="300" height="300" src="img/repo-url-qr.png" />
					</p>

					<h4>kortreistkode.no</h4>
					<h4>Jonas Nordstrand / Anders Gjendem</h4>

					<aside class="notes">
						<h6>En av oss:</h6>
						<p>
							Hejdå!
						</p>
					</aside>
				</section>
			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true }
				]
			});
		</script>
	</body>
</html>
